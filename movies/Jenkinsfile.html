<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<title>~/DO288-apps/movies/Jenkinsfile.html</title>
<meta name="Generator" content="Vim/7.4">
<meta name="plugin-version" content="vim7.4_v1">
<meta name="syntax" content="none">
<meta name="settings" content="use_css,pre_wrap,no_foldcolumn,prevent_copy=">
<meta name="colorscheme" content="none">
<style type="text/css">
<!--
pre { white-space: pre-wrap; font-family: monospace; color: #000000; background-color: #ffffff; }
body { font-family: monospace; color: #000000; background-color: #ffffff; }
* { font-size: 1em; }
-->
</style>

<script type='text/javascript'>
<!--

-->
</script>
</head>
<body>
<pre id='vimCodeElement'>
pipeline {
    options {
        // set a timeout of 60 minutes for this pipeline
        timeout(time: 60, unit: 'MINUTES')
    }
    agent {
      node {
        //TODO: Add label for the Maven jenkins agent
        label 'maven'
      }
    }

    environment {
        //TODO: Customize these variables for your environment
        DEV_PROJECT = &quot;dimikhan-movies-dev&quot;
        STAGE_PROJECT = &quot;dimikhan-movies-stage&quot;
        APP_GIT_URL = &quot;<a href="https://github.com/dimikhan/DO288-apps">https://github.com/dimikhan/DO288-apps</a>&quot;
        NEXUS_SERVER = &quot;<a href="http://nexus-common.apps.ap45.prod.nextcle.com/repository/java">http://nexus-common.apps.ap45.prod.nextcle.com/repository/java</a>&quot;

        // DO NOT CHANGE THE GLOBAL VARS BELOW THIS LINE
        APP_NAME = &quot;movies&quot;
    }


    stages {

        stage('Compilation Check') {
            steps {
                echo '### Checking for compile errors ###'
                sh '''
                        cd ${APP_NAME}
                        mvn -s settings.xml -B clean compile
                   '''
            }
        }

        stage('Run Unit Tests') {
            steps {
                echo '### Running unit tests ###'
                sh '''
                        cd ${APP_NAME}
                        mvn -s settings.xml -B clean test
                   '''
            }
        }

        stage('Static Code Analysis') {
            steps {
                echo '### Running pmd on code ###'
                sh '''
                        cd ${APP_NAME}
                        mvn -s settings.xml -B clean pmd:check
                   '''
            }
        }

        stage('Create fat JAR') {
            steps {
                echo '### Creating fat JAR ###'
                sh '''
                        cd ${APP_NAME}
                        mvn -s settings.xml -B clean package -DskipTests=true
                   '''
            }
        }

        stage('Launch new app in DEV env') {
            steps {
                echo '### Cleaning existing resources in DEV env ###'
                sh '''
                        oc delete all -l app=${APP_NAME} -n ${DEV_PROJECT}
                        oc delete all -l build=${APP_NAME} -n ${DEV_PROJECT}
                        sleep 5
                        oc new-build java:8 --name=${APP_NAME} --binary=true -n ${DEV_PROJECT}
                   '''

                echo '### Creating a new app in DEV env ###'
                script {
                    openshift.withCluster() {
                      openshift.withProject(env.DEV_PROJECT) {
                        openshift.selector(&quot;bc&quot;, &quot;${APP_NAME}&quot;).startBuild(&quot;--from-file=${APP_NAME}/target/${APP_NAME}.jar&quot;, &quot;--wait=true&quot;, &quot;--follow=true&quot;)
                      }
                    }
                }
                // TODO: Create a new OpenShift application based on the ${APP_NAME}:latest image stream
sh '''
oc new-app --as-deployment-config --name $APP_NAME -i ${APP_NAME}:latest
oc expose svc/${APP_NAME}
'''
                // TODO: Expose the ${APP_NAME} service for external access
            }
        }

        stage('Wait for deployment in DEV env') {
            //TODO: Watch deployment until pod is in 'Running' state
        }

        stage('Promote to Staging Env') {
            steps {
                timeout(time: 60, unit: 'MINUTES') {
                    input message: &quot;Promote to Staging?&quot;
                }
                script {
                    openshift.withCluster() {
                    // TODO: Tag the ${APP_NAME}:latest image stream in the dev env as ${APP_NAME}:stage in staging
                    }
                }
            }
        }

        stage('Deploy to Staging Env') {
            steps {
                echo '### Cleaning existing resources in Staging ###'
                sh '''
                        oc project ${STAGE_PROJECT}
                        oc delete all -l app=${APP_NAME}
                        sleep 5
                   '''

                echo '### Creating a new app in Staging ###'
                // TODO: Create a new app in staging and expose the service
            }
        }

        stage('Wait for deployment in Staging') {
            steps {
                sh &quot;oc get route ${APP_NAME} -n ${STAGE_PROJECT} -o jsonpath='{ .spec.host }' --loglevel=4 &gt; routehost&quot;

                script {
                    routeHost = readFile('routehost').trim()

                    openshift.withCluster() {
                        openshift.withProject( &quot;${STAGE_PROJECT}&quot; ) {
                            def deployment = openshift.selector(&quot;dc&quot;, &quot;${APP_NAME}&quot;).rollout()
                            openshift.selector(&quot;dc&quot;, &quot;${APP_NAME}&quot;).related('pods').untilEach(1) {
                                return (it.object().status.phase == &quot;Running&quot;)
                            }
                        }
                        echo &quot;Deployment to Staging env is complete. Access the API endpoint at the URL <a href="http://${routeHost}/movies.">http://${routeHost}/movies.</a>&quot;
                    }
                }
            }
        }
    }
}
</pre>
</body>
</html>
<!-- vim: set foldmethod=manual : -->
